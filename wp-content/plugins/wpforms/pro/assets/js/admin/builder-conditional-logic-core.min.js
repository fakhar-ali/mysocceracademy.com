"use strict";var WPFormsConditionals=window.WPFormsConditionals||function(i,s){var o={arraySplitIntoChunks:function(e,i){return e.length?[e.slice(0,i)].concat(o.arraySplitIntoChunks(e.slice(i),i)):[]}},d={allFields:{},$ruleRows:{},conditionalFields:{},fieldsListTemplate:"",fieldValuesListTemplates:{},cacheAllFields:function(e){d.allFields=e},cacheRuleRows:function(e){d.$ruleRows=e||s(".wpforms-conditional-row")},setConditionalFields:function(){d.conditionalFields=d.removeUnsupportedFields()},removeUnsupportedFields:function(){var e,i=wpforms_builder.cl_fields_supported,o=s.extend({},d.allFields);for(e in o)(-1===s.inArray(o[e].type,i)||void 0!==o[e].dynamic_choices&&""!==o[e].dynamic_choices)&&delete o[e];return o},setTemplates:function(){d.setFieldsListTemplate(),d.fieldValuesListTemplates={}},setFieldsListTemplate:function(){var e,i,o=s("<select>").append(s("<option>",{value:"",text:wpforms_builder.select_field}));for(e in wpf.orders.fields){var t=wpf.orders.fields[e];d.conditionalFields[t]&&(i=void 0!==d.conditionalFields[t].label&&""!==d.conditionalFields[t].label.toString().trim()?wpf.sanitizeHTML(d.conditionalFields[t].label.toString().trim()):wpforms_builder.field+" #"+d.conditionalFields[t].id,o.append(s("<option>",{value:d.conditionalFields[t].id,text:i,id:"option-"+t})))}d.fieldsListTemplate=o.html()},getFieldValuesListTemplate:function(e,i){if(d.fieldValuesListTemplates[i])return d.fieldValuesListTemplates[i];var o,t=wpf.orders.choices["field_"+i],n=s("<select>");for(o in t){var l=t[o],a=void 0!==e[i].choices[l]&&""!==e[i].choices[l].label.toString().trim()?wpf.sanitizeHTML(e[i].choices[l].label.toString().trim()):wpforms_builder.choice_empty_label_tpl.replace("{number}",l);n.append(s("<option>",{value:l,text:a,id:"choice-"+l}))}return d.fieldValuesListTemplates[i]=n.html()},updateConditionalRuleRows:function(){d.$ruleRows.length;o.arraySplitIntoChunks(d.$ruleRows,20).map(function(i){setTimeout(function(){for(var e=0;e<i.length;++e)d.updateConditionalRuleRow(i[e]),0},0)})},updateConditionalRuleRow:function(e){var i=s(e),o=i.attr("data-field-id"),t=i.find(".wpforms-conditional-field"),n=t.val(),e=i.find(".wpforms-conditional-value");t[0].innerHTML=d.fieldsListTemplate,t.find("#option-"+o).remove(),n?(t.find("#option-"+n).length?d.restorePreviousRuleRowSelection(i,t,n,e):d.removeRuleRow(i),t.find("option").removeAttr("id"),e.find("option").removeAttr("id")):t.find("option").removeAttr("id")},fieldDeleteConfirmAlert:function(e){var i,o=wpforms_builder.conditionals_change+"<br>";wpf.empty(d.allFields)&&d.cacheAllFields(wpf.getFields()),s(".wpforms-conditional-field").each(function(){e.id===Number(s(this).val())&&(e.choiceId&&e.choiceId!==Number(s(this).closest(".wpforms-conditional-row").find(".wpforms-conditional-value").val())||(o+=d.getChangedFieldNameForAlert(s(this).closest(".wpforms-conditional-group").data("reference")),i=!0,e.trigger=!0))}),i&&(e.message="<strong>"+e.message+"</strong><br><br>"+o)},restorePreviousRuleRowSelection:function(e,i,o,t){var n;i.find("#option-"+o).prop("selected",!0),t.length&&t.is("select")&&(n=t.val(),t[0].innerHTML=d.getFieldValuesListTemplate(d.conditionalFields,o),t.find("#choice-"+n).length&&t.find("#choice-"+n).prop("selected",!0))},removeRuleRow:function(e){var i=e.closest(".wpforms-conditional-group");1===i.find("table >tbody >tr").length?1<e.closest(".wpforms-conditional-groups").find(".wpforms-conditional-group").length?i.remove():(e.find(".wpforms-conditional-value").remove(),e.find(".value").append("<select>")):e.remove()},getChangedFieldNameForAlert:function(e){return wpf.isNumber(e)?((d.allFields[e]||{}).label||"").length?"<br/>"+wpf.sanitizeString(d.allFields[e].label)+" ("+wpforms_builder.field+" #"+e+")":"<br>"+wpforms_builder.field+" #"+e:"<br>"+e}};return{init:function(){s(WPFormsConditionals.ready)},ready:function(){WPFormsConditionals.bindUIActions()},bindUIActions:function(){var e=s("#wpforms-builder");e.on("change",".wpforms-conditionals-enable-toggle input[type=checkbox]",function(e){WPFormsConditionals.conditionalToggle(this,e)}),e.on("change",".wpforms-conditional-field",function(e){WPFormsConditionals.conditionalField(this,e)}),e.on("change",".wpforms-conditional-operator",function(e){WPFormsConditionals.conditionalOperator(this,e)}),e.on("click",".wpforms-conditional-rule-add",function(e){WPFormsConditionals.conditionalRuleAdd(this,e)}),e.on("click",".wpforms-conditional-rule-delete",function(e){WPFormsConditionals.conditionalRuleDelete(this,e)}),e.on("click",".wpforms-conditional-groups-add",function(e){WPFormsConditionals.conditionalGroupAdd(this,e)}),s(i).on("wpformsFieldUpdate",WPFormsConditionals.conditionalUpdateOptions),e.on("wpformsBeforeFieldDeleteAlert",function(e,i){d.fieldDeleteConfirmAlert(i)})},conditionalUpdateOptions:function(e,i,o){wpf.empty(i)||(d.cacheAllFields(i),d.cacheRuleRows(o),d.setConditionalFields(),d.setTemplates(),d.updateConditionalRuleRows())},conditionalToggle:function(e,i){i.preventDefault();var o=s(e),t=o.closest(".wpforms-conditional-block"),i=wp.template("wpforms-conditional-block"),e={fieldID:o.closest(".wpforms-field-option-row").data("field-id"),fieldName:o.data("name"),actions:o.data("actions"),actionDesc:o.data("action-desc")};o.is(":checked")?(t.append(i(e)),WPFormsConditionals.conditionalUpdateOptions(!1,wpf.getFields(!1,!0),t.find(".wpforms-conditional-row"))):s.confirm({title:!1,content:wpforms_builder.conditionals_disable,backgroundDismiss:!1,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){t.find(".wpforms-conditional-groups").remove()}},cancel:{text:wpforms_builder.cancel,action:function(){o.prop("checked",!0)}}}})},conditionalField:function(e,i){i.preventDefault();var o,t=s(e),n=t.parent().parent(),l=n.find(".wpforms-conditional-operator"),i=l.find("option:selected").val(),a=WPFormsConditionals.conditionalData(t),e=a.inputName+"["+a.groupID+"]["+a.ruleID+"][value]";if(a.field)if("select"===a.field.type||"radio"===a.field.type||"checkbox"===a.field.type||"payment-multiple"===a.field.type||"payment-checkbox"===a.field.type||"payment-select"===a.field.type){if((o=s("<select>").attr({name:e,class:"wpforms-conditional-value"})).append(s("<option>",{value:"",text:wpforms_builder.select_choice})),a.field.choices)for(var d in wpf.orders.choices["field_"+a.field.id]){var r=wpf.orders.choices["field_"+a.field.id][d],d=void 0!==a.field.choices[r].label&&""!==a.field.choices[r].label.toString().trim()?wpf.sanitizeHTML(a.field.choices[r].label.toString().trim()):wpforms_builder.choice_empty_label_tpl.replace("{number}",r);o.append(s("<option>",{value:r,text:wpf.sanitizeHTML(d)}))}l.find("option:not([value='=='],[value='!='],[value='e'],[value='!e'])").prop("disabled",!0).prop("selected",!1)}else{t="text";"rating"!==a.field.type&&"net_promoter_score"!==a.field.type&&"number-slider"!==a.field.type||(t="number"),o=s("<input>").attr({type:t,name:e,class:"wpforms-conditional-value"}),l.find("option").prop("disabled",!1)}else o=s("<select>");"e"!==i&&"!e"!==i||o.prop("disabled",!0),n.find(".value").empty().append(o)},conditionalOperator:function(e,i){i.preventDefault();i=s(e),e=i.parent().parent().find(".wpforms-conditional-value"),i=i.find("option:selected").val();"e"===i||"!e"===i?(e.prop("disabled",!0),e.is("select")?e.find("option:selected").prop("selected",!1):e.val("")):e.prop("disabled",!1)},conditionalRuleAdd:function(e,i){i.preventDefault();var o=s(e).closest(".wpforms-conditional-group").find("tr").last(),t=o.clone(),n=t.find(".wpforms-conditional-field"),l=t.find(".wpforms-conditional-operator"),i=WPFormsConditionals.conditionalData(n),e=Number(i.ruleID)+1,i=i.inputName+"["+i.groupID+"]["+e+"]";t.find("option:selected").prop("selected",!1),t.find(".value").empty().append(s("<select>")),n.attr("name",i+"[field]").attr("data-ruleid",e),l.attr("name",i+"[operator]"),o.after(t)},conditionalRuleDelete:function(e,i){i.preventDefault();var o=s(e),i=o.closest(".wpforms-conditional-group"),e=i.find("table >tbody >tr");e&&1===e.length?1<o.closest(".wpforms-conditional-groups").find(".wpforms-conditional-group").length?i.remove():(e.find(".wpforms-conditional-operator").val("==").trigger("change"),e.find(".wpforms-conditional-value").val("").trigger("change"),e.find(".wpforms-conditional-field").val("").trigger("change")):o.parent().parent().remove()},conditionalGroupAdd:function(e,i){i.preventDefault();var o=s(e),t=o.parent().find(".wpforms-conditional-group").last().clone();t.find("tr").not(":first").remove();var n=t.find(".wpforms-conditional-field"),l=t.find(".wpforms-conditional-operator"),i=WPFormsConditionals.conditionalData(n),e=Number(i.groupID)+1,i=i.inputName+"["+e+"][0]";t.find("option:selected").prop("selected",!1),t.find(".value").empty().append(s("<select>")),n.attr("name",i+"[field]").attr("data-ruleid",0).attr("data-groupid",e),l.attr("name",i+"[operator]"),o.before(t)},conditionalData:function(e){e=s(e),e={fields:wpf.getFields(!1,!0),inputBase:e.closest(".wpforms-conditional-row").attr("data-input-name"),fieldID:e.closest(".wpforms-conditional-row").attr("data-field-id"),ruleID:e.attr("data-ruleid"),groupID:e.attr("data-groupid"),selectedID:e.find(":selected").val()};return e.inputName=e.inputBase+"[conditionals]",e.selectedID.length?e.field=e.fields[e.selectedID]:e.field=!1,e}}}(document,(window,jQuery));WPFormsConditionals.init();